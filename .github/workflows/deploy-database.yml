name: Deploy Database Dashboard

on:
  workflow_dispatch:
    inputs:
      monitoring_project_id:
        description: "Proyecto central de monitoreo"
        required: true
      monitoring_region:
        description: "RegiÃ³n del proyecto de monitoreo"
        required: true
        default: "us-central1"
      database_project_id:
        description: "Proyecto con las bases de datos"
        required: true
      database_instance:
        description: "Nombre de la instancia de Cloud SQL"
        required: true
      database_name:
        description: "Nombre de la base de datos"
        required: true
      enable_alerts:
        description: "Habilitar alertas (true/false)"
        required: true
        default: "true"
      notification_emails_json:
        description: "Lista de emails en JSON, ejemplo: [\"a@b.com\", \"c@d.com\"]"
        required: false
        default: "[]"
      slack_channel_name:
        description: "Canal de Slack (opcional)"
        required: false
        default: "#alerts"
      auth_method:
        description: "MÃ©todo de autenticaciÃ³n"
        required: true
        default: "service_account"
        type: choice
        options:
          - workload_identity
          - service_account

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_VAR_dashboard_type: "database"
      TF_VAR_monitoring_project_id: ${{ github.event.inputs.monitoring_project_id }}
      TF_VAR_monitoring_region: ${{ github.event.inputs.monitoring_region }}
      TF_VAR_database_project_id: ${{ github.event.inputs.database_project_id }}
      TF_VAR_database_instance: ${{ github.event.inputs.database_instance }}
      TF_VAR_database_name: ${{ github.event.inputs.database_name }}
      TF_VAR_enable_alerts: ${{ github.event.inputs.enable_alerts }}
      TF_VAR_notification_emails: ${{ github.event.inputs.notification_emails_json }}
      TF_VAR_slack_channel_name: ${{ github.event.inputs.slack_channel_name }}
      TF_VAR_slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Display Configuration
        shell: bash
        run: |
          echo "================================================"
          echo "ðŸš€ Deploying Database Dashboard"
          echo "================================================"
          echo "ðŸ“Š Dashboard Type: Database"
          echo "ðŸŽ¯ Monitoring Project: ${{ github.event.inputs.monitoring_project_id }}"
          echo "ðŸ“ Monitoring Region: ${{ github.event.inputs.monitoring_region }}"
          echo "ðŸ—„ï¸  Database Project: ${{ github.event.inputs.database_project_id }}"
          echo "ðŸ”§ Database Instance: ${{ github.event.inputs.database_instance }}"
          echo "ðŸ“› Database Name: ${{ github.event.inputs.database_name }}"
          echo "ðŸ”” Alerts Enabled: ${{ github.event.inputs.enable_alerts }}"
          echo "ðŸ’¬ Auth Method: ${{ github.event.inputs.auth_method }}"
          echo "================================================"

      - name: Validate Auth Inputs
        shell: bash
        env:
          AUTH_METHOD: ${{ github.event.inputs.auth_method }}
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          WORKLOAD_IDENTITY_PROVIDER: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          GCP_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT }}
        run: |
          if [ "$AUTH_METHOD" = "service_account" ]; then
            if [ -z "$GCP_SA_KEY" ]; then
              echo "ERROR: auth_method=service_account but secret GCP_SA_KEY is not set or not available in this run."
              echo "If this run originates from a fork (or Dependabot), secrets are not passed. Run from the base repository or set the secret in the repository settings."
              exit 1
            fi
          elif [ "$AUTH_METHOD" = "workload_identity" ]; then
            if [ -z "$WORKLOAD_IDENTITY_PROVIDER" ] || [ -z "$GCP_SERVICE_ACCOUNT" ]; then
              echo "ERROR: auth_method=workload_identity but WORKLOAD_IDENTITY_PROVIDER or GCP_SERVICE_ACCOUNT secrets are missing."
              exit 1
            fi
          else
            echo "ERROR: unknown auth_method: $AUTH_METHOD"
            exit 1
          fi

      - name: Authenticate with Service Account
        if: github.event.inputs.auth_method == 'service_account'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate with Workload Identity
        if: github.event.inputs.auth_method == 'workload_identity'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Normalize boolean inputs
        shell: bash
        run: |
          if [ "${{ github.event.inputs.enable_alerts }}" = "true" ]; then
            echo "TF_VAR_enable_alerts=true" >> $GITHUB_ENV
          else
            echo "TF_VAR_enable_alerts=false" >> $GITHUB_ENV
          fi

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform/dashboard
        run: terraform init

      - name: Terraform Plan
        working-directory: terraform/dashboard
        run: terraform plan

      - name: Terraform Apply
        working-directory: terraform/dashboard
        run: terraform apply -auto-approve

      - name: Display Outputs
        working-directory: terraform/dashboard
        shell: bash
        run: |
          echo ""
          echo "================================================"
          echo "âœ… Database Dashboard Deployed Successfully!"
          echo "================================================"
          terraform output -raw gcp_console_url
          echo ""
