name: Deploy GKE Dashboard with Terraform

on:
  workflow_dispatch:
    inputs:
      dashboard_type:
        description: "Tipo de dashboard a desplegar"
        required: true
        type: choice
        options:
          - kubernetes
          - database
      
      # Variables comunes
      monitoring_project_id:
        description: "Proyecto central de monitoreo (REQUERIDO PARA AMBOS)"
        required: true
      monitoring_region:
        description: "Regi√≥n del proyecto de monitoreo"
        required: true
        default: "us-central1"
      
      # Variables para Kubernetes Dashboard
      target_project_id:
        description: "[K8s ONLY] Proyecto con el cl√∫ster GKE - DEJAR VAC√çO si seleccionaste 'database'"
        required: false
      cluster_name:
        description: "[K8s ONLY] Nombre del cl√∫ster GKE - DEJAR VAC√çO si seleccionaste 'database'"
        required: false
      
      # Variables para Database Dashboard
      database_project_id:
        description: "[DB ONLY] Proyecto con las bases de datos - DEJAR VAC√çO si seleccionaste 'kubernetes'"
        required: false
      database_instance:
        description: "[DB ONLY] Nombre de la instancia de Cloud SQL - DEJAR VAC√çO si seleccionaste 'kubernetes'"
        required: false
      database_name:
        description: "[DB ONLY] Nombre de la base de datos - DEJAR VAC√çO si seleccionaste 'kubernetes'"
        required: false
      
      # Alertas comunes
      enable_alerts:
        description: "Habilitar alertas (true/false)"
        required: true
        default: "true"
      notification_emails_json:
        description: "Lista de emails en JSON, ejemplo: [\"a@b.com\"] - DEJAR VAC√çO si no quieres alertas"
        required: false
        default: "[]"
      slack_channel_name:
        description: "Canal de Slack (opcional)"
        required: false
        default: "#alerts"
      auth_method:
        description: "M√©todo de autenticaci√≥n: 'workload_identity' o 'service_account'"
        required: true
        default: "service_account"
        type: choice
        options:
          - workload_identity
          - service_account

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TF_VAR_dashboard_type: ${{ github.event.inputs.dashboard_type }}
      TF_VAR_monitoring_project_id: ${{ github.event.inputs.monitoring_project_id }}
      TF_VAR_monitoring_region: ${{ github.event.inputs.monitoring_region }}
      TF_VAR_target_project_id: ${{ github.event.inputs.target_project_id }}
      TF_VAR_cluster_name: ${{ github.event.inputs.cluster_name }}
      TF_VAR_database_project_id: ${{ github.event.inputs.database_project_id }}
      TF_VAR_database_instance: ${{ github.event.inputs.database_instance }}
      TF_VAR_database_name: ${{ github.event.inputs.database_name }}
      TF_VAR_enable_alerts: ${{ github.event.inputs.enable_alerts }}
      TF_VAR_notification_emails: ${{ github.event.inputs.notification_emails_json }}
      TF_VAR_slack_channel_name: ${{ github.event.inputs.slack_channel_name }}
      TF_VAR_slack_webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate inputs for dashboard type
        shell: bash
        run: |
          DASHBOARD_TYPE="${{ github.event.inputs.dashboard_type }}"
          
          echo "üìä Dashboard type: $DASHBOARD_TYPE"
          echo "================================================"
          
          if [ "$DASHBOARD_TYPE" = "kubernetes" ]; then
            echo "‚úÖ Kubernetes Dashboard Mode"
            if [ -z "${{ github.event.inputs.target_project_id }}" ] || [ -z "${{ github.event.inputs.cluster_name }}" ]; then
              echo "‚ùå ERROR: target_project_id y cluster_name son REQUERIDOS para Kubernetes"
              exit 1
            fi
            echo "‚úÖ Variables de Kubernetes validadas"
          elif [ "$DASHBOARD_TYPE" = "database" ]; then
            echo "‚úÖ Database Dashboard Mode"
            if [ -z "${{ github.event.inputs.database_project_id }}" ] || [ -z "${{ github.event.inputs.database_instance }}" ] || [ -z "${{ github.event.inputs.database_name }}" ]; then
              echo "‚ùå ERROR: database_project_id, database_instance y database_name son REQUERIDOS para Database"
              exit 1
            fi
            echo "‚úÖ Variables de Database validadas"
          else
            echo "‚ùå ERROR: dashboard_type no v√°lido"
            exit 1
          fi
          
          echo "================================================"
          echo "Monitoring Project: ${{ github.event.inputs.monitoring_project_id }}"
          echo "Monitoring Region: ${{ github.event.inputs.monitoring_region }}"
          echo "Alerts Enabled: ${{ github.event.inputs.enable_alerts }}"

      - name: Authenticate with Service Account
        if: github.event.inputs.auth_method == 'service_account'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Authenticate with Workload Identity
        if: github.event.inputs.auth_method == 'workload_identity'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: terraform/dashboard
        run: terraform init

      - name: Terraform Apply
        working-directory: terraform/dashboard
        run: terraform apply -auto-approve
